# Video Review Suite

A complete video review and motion analysis platform for table tennis coaching. Built as a self-contained module that can be integrated into existing React applications.

## Features

- **Video Upload**: Direct file upload with local storage
- **Video Processing**: Automatic normalization to 720p H.264 with FFmpeg
- **Coach Review Tools**:
  - Slow-motion playback (0.25x - 2x)
  - Frame-by-frame navigation
  - Timeline with seeking and markers
  - Keyboard shortcuts (Space, [ ])
- **Canvas Annotations**:
  - Arrow, circle, and freehand drawing tools
  - Timestamped annotations that appear/disappear with video
  - Save/load annotation sessions as JSON
  - Undo last annotation
- **Clip Creation**: Server-side FFmpeg clip extraction with status tracking
- **Student Portal**: View videos with coach annotations and clips
- **Role-Based Auth**: JWT Bearer tokens with STUDENT/COACH roles
- **Real-time Updates**: Polling for processing status

## Architecture

### Stack

**Backend** (`apps/backend`):
- Node.js + Express + TypeScript
- PostgreSQL via Prisma ORM
- Local file system storage
- FFmpeg CLI for video processing
- JWT authentication (HS256)
- In-memory job queue with retry/backoff

**Frontend** (`apps/frontend`):
- React 18 + TypeScript + Vite
- TailwindCSS for styling
- react-konva for canvas annotations
- hls.js for HLS video playback
- Zustand for state management

**Infrastructure**:
- pnpm workspaces for monorepo management

## Prerequisites

- **Node.js** >= 18.0.0
- **pnpm** >= 8.0.0
- **PostgreSQL** (local installation)
- **FFmpeg** installed and available in PATH ([download](https://ffmpeg.org/download.html))

### Installing FFmpeg

**Windows**: Download from [ffmpeg.org](https://ffmpeg.org/download.html) and add to PATH

**macOS**:
```bash
brew install ffmpeg
```

**Linux**:
```bash
sudo apt update && sudo apt install ffmpeg
```

Verify installation:
```bash
ffmpeg -version
```

### Installing PostgreSQL

**Windows**: Download from [postgresql.org](https://www.postgresql.org/download/windows/)

**macOS**:
```bash
brew install postgresql@15
brew services start postgresql@15
```

**Linux**:
```bash
sudo apt update && sudo apt install postgresql
```

## Quick Start

### 1. Clone and Install

```bash
cd video-review-suite
pnpm install
```

### 2. Configure Environment

Copy the `.env.example` file:

```bash
cp .env.example .env
```

Update the `DATABASE_URL` if your PostgreSQL credentials are different:

```
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/video_review
```

### 3. Set Up Database

```bash
pnpm db:setup
```

This will run migrations and seed the database with test users.

### 4. Start the Application

```bash
pnpm dev
```

This will:
1. Start backend on http://localhost:4000
2. Start frontend on http://localhost:5173

### 5. Get JWT Tokens

After seeding, the backend logs will print two JWT tokens:

```
=== JWT Tokens for Testing ===

Student Token:
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

Coach Token:
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

Copy these tokens to authenticate in the frontend demo.

### 6. Open the App

Navigate to http://localhost:5173 and paste a token to enter as Student or Coach.

## Usage

### Student Workflow

1. Upload a video (MP4/AVI/MOV)
2. Wait for processing (status updates automatically)
3. View video with coach annotations overlaid
4. Play clips created by coach

### Coach Workflow

1. Select a student video from the list
2. Use playback controls (play/pause, speed, frame step)
3. Select annotation tool (arrow, circle, freehand)
4. Draw on video at specific timestamps
5. Add timeline markers with comments
6. Save annotation session
7. Create clips by marking start/end times
8. Export annotated video (optional)

### Keyboard Shortcuts

- **Space**: Play/Pause
- **[**: Previous frame
- **]**: Next frame

## API Documentation

### Authentication

All endpoints (except `/health`) require:

```
Authorization: Bearer <JWT_TOKEN>
```

### Endpoints

#### Health Check

```bash
curl http://localhost:4000/health
```

#### Upload Video

**Step 1**: Get upload information

```bash
curl -X POST http://localhost:4000/api/upload/presign \
  -H "Authorization: Bearer <TOKEN>" \
  -H "Content-Type: application/json" \
  -d '{
    "filename": "swing.mp4",
    "contentType": "video/mp4"
  }'
```

Response:
```json
{
  "url": "http://localhost:4000/api/upload/direct/...",
  "storageKey": "uploads/user123/1234567890_swing.mp4",
  "playbackUrl": "http://localhost:4000/api/files/uploads/..."
}
```

**Step 2**: Upload file to the provided URL

```bash
curl -X POST "<upload_url>" \
  -H "Authorization: Bearer <TOKEN>" \
  -H "Content-Type: video/mp4" \
  --data-binary @swing.mp4
```

**Step 3**: Register video

```bash
curl -X POST http://localhost:4000/api/videos \
  -H "Authorization: Bearer <TOKEN>" \
  -H "Content-Type: application/json" \
  -d '{
    "studentId": "<user_id>",
    "storageKey": "uploads/user123/1234567890_swing.mp4",
    "playbackUrl": "http://localhost:4000/api/files/uploads/..."
  }'
```

#### List Videos

```bash
curl http://localhost:4000/api/videos \
  -H "Authorization: Bearer <TOKEN>"
```

#### Get Video

```bash
curl http://localhost:4000/api/videos/<video_id> \
  -H "Authorization: Bearer <TOKEN>"
```

#### Create Annotation

```bash
curl -X POST http://localhost:4000/api/annotations \
  -H "Authorization: Bearer <COACH_TOKEN>" \
  -H "Content-Type: application/json" \
  -d '{
    "videoId": "<video_id>",
    "name": "Forehand Analysis",
    "payload": {
      "videoId": "<video_id>",
      "framesPerSecond": 30,
      "items": [
        {
          "type": "arrow",
          "at": 2.5,
          "props": {
            "points": [100, 100, 200, 200],
            "stroke": "#ff0000",
            "width": 3
          }
        }
      ],
      "comments": [
        {
          "at": 2.5,
          "text": "Watch elbow position here"
        }
      ]
    }
  }'
```

#### Get Annotations for Video

```bash
curl http://localhost:4000/api/videos/<video_id>/annotations \
  -H "Authorization: Bearer <TOKEN>"
```

#### Create Clip

```bash
curl -X POST http://localhost:4000/api/clips \
  -H "Authorization: Bearer <COACH_TOKEN>" \
  -H "Content-Type: application/json" \
  -d '{
    "videoId": "<video_id>",
    "startSeconds": 5.0,
    "endSeconds": 10.0,
    "comment": "Key moment in the rally"
  }'
```

#### Get Clips for Video

```bash
curl http://localhost:4000/api/videos/<video_id>/clips \
  -H "Authorization: Bearer <TOKEN>"
```

#### Render Annotated Video

```bash
curl -X POST http://localhost:4000/api/render/annotated-video \
  -H "Authorization: Bearer <COACH_TOKEN>" \
  -H "Content-Type: application/json" \
  -d '{
    "videoId": "<video_id>",
    "annotationId": "<annotation_id>"
  }'
```

Response:
```json
{
  "jobId": "render_...",
  "status": "processing"
}
```

Check status:
```bash
curl http://localhost:4000/api/render/jobs/<job_id> \
  -H "Authorization: Bearer <TOKEN>"
```

## Project Structure

```
video-review-suite/
├── apps/
│   ├── backend/
│   │   ├── src/
│   │   │   ├── auth/          # JWT + middleware
│   │   │   ├── db/            # Prisma client
│   │   │   ├── ffmpeg/        # Video processing
│   │   │   ├── routes/        # Express endpoints
│   │   │   ├── storage/       # Local file storage
│   │   │   ├── types/         # TypeScript types
│   │   │   ├── utils/         # Logger
│   │   │   ├── env.ts         # Environment validation
│   │   │   ├── server.ts      # Express setup
│   │   │   └── index.ts       # Entry point
│   │   └── prisma/
│   │       ├── schema.prisma  # Database schema
│   │       └── seed.ts        # Test data
│   └── frontend/
│       └── src/
│           ├── components/    # React components
│           ├── lib/           # API + auth utilities
│           ├── store/         # Zustand state
│           └── styles/        # Tailwind CSS
├── package.json               # Root scripts
└── pnpm-workspace.yaml        # Monorepo config
```

## Environment Variables

### Backend (`apps/backend/.env`)

```bash
# Server
PORT=4000
NODE_ENV=development

# JWT
JWT_SECRET=your_secret_key_here

# Database
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/video_review
```

### Frontend (`apps/frontend/.env`)

```bash
VITE_API_BASE_URL=http://localhost:4000
```

## Development Commands

### Root

```bash
pnpm dev           # Start everything
pnpm build         # Build both apps
pnpm db:setup      # Setup database
pnpm db:reset      # Reset database
```

### Backend

```bash
pnpm --filter backend dev          # Dev with auto-reload
pnpm --filter backend build        # Compile TypeScript
pnpm --filter backend db:migrate   # Run migrations
pnpm --filter backend db:seed      # Seed test data
```

### Frontend

```bash
pnpm --filter frontend dev         # Dev server (port 5173)
pnpm --filter frontend build       # Production build
pnpm --filter frontend preview     # Preview build
```

## Deployment

### Backend

1. Set production environment variables
2. Use a real PostgreSQL instance
3. Ensure FFmpeg is installed on the server
4. Build: `pnpm --filter backend build`
5. Start: `pnpm --filter backend start`

### Frontend

1. Set `VITE_API_BASE_URL` to production backend
2. Build: `pnpm --filter frontend build`
3. Deploy `apps/frontend/dist` to static hosting (Vercel, Netlify, etc.)

### Integrating into Existing App

The `VideoReviewSuite` component is designed to be embedded:

```tsx
import VideoReviewSuite from './components/VideoReviewSuite';

// In your route
<VideoReviewSuite
  mode="coach"  // or "student"
  userId="user_id_from_your_auth"
/>
```

## Troubleshooting

### FFmpeg not found

Ensure FFmpeg is installed and in PATH:
```bash
ffmpeg -version
```

### Database connection issues

Check that PostgreSQL is running and credentials are correct:
```bash
psql -U postgres -h localhost
```

### Video processing stuck

Check backend logs for FFmpeg errors. Common issues:
- Input video corrupt or unsupported codec
- FFmpeg not installed or wrong version
- Insufficient disk space in temp directory

### CORS errors in frontend

Ensure backend `cors()` middleware is enabled and frontend URL is allowed.

## Database Schema

### User
- `id`: Unique identifier
- `email`: Email address
- `role`: STUDENT | COACH

### Video
- `id`: Unique identifier
- `studentId`: Owner
- `coachId`: Assigned coach (optional)
- `storageKey`: File system path
- `playbackUrl`: API endpoint URL
- `status`: UPLOADED | PROCESSING | READY | FAILED
- `durationSeconds`: Video length
- `format`: File format (e.g., mp4)

### Annotation
- `id`: Unique identifier
- `videoId`: Associated video
- `coachId`: Creator
- `name`: Annotation session name
- `payload`: JSON with items + comments

### Clip
- `id`: Unique identifier
- `videoId`: Source video
- `coachId`: Creator
- `startSeconds`: Start time
- `endSeconds`: End time
- `comment`: Optional description
- `outputStorageKey`: File system path for rendered clip
- `outputUrl`: API endpoint URL
- `status`: QUEUED | RENDERING | READY | FAILED

## Technology Choices

### Why local file storage?

- Simple deployment without external dependencies
- No cloud costs
- Fast local access
- Easy backup and management

### Why FFmpeg CLI instead of library?

- More stable and feature-rich
- Easier to debug
- Works cross-platform
- Battle-tested in production

### Why in-memory job queue?

- Zero external dependencies (no Redis/RabbitMQ)
- Simple retry/backoff logic
- Easy to swap for BullMQ/Bee-Queue later

### Why react-konva?

- Canvas-based annotations for performance
- Rich shape primitives
- Export to JSON/image
- Active community

## License

MIT

## Support

For issues or questions, please open an issue on GitHub or contact the development team.

---

Built with ❤️ for table tennis coaches and athletes.
